@using Microsoft.AspNetCore.Components.WebAssembly.Hosting

@inherits LayoutBase
@inject SettingManager SettingManager
@inject ShiftIdentityDashboardBlazorOptions ShiftIdentityDashboardBlazorOptions
@inject IWebAssemblyHostEnvironment Env
@inject HttpClient HttpClient
@inject ISnackbar Snackbar
@inject ShiftIdentityLocalizer Loc

<MudRTLProvider RightToLeft="SettingManager.GetLanguage().RTL">

    <AddMudProviders />

    <MudLayout>

        <MudAppBar>
            <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" OnClick="@((e) => DrawerToggle())" />
            <MudLink Href="/"><MudText Style="color: #fff;">@ShiftIdentityDashboardBlazorOptions.Title</MudText></MudLink>

            <MudSpacer />

            @if (Env.IsStaging() || Env.IsDevelopment())
            {
                <UserAvatar>
                    <MenuItemsTemplate>
                        <MudListItem OnClick="PullData" T="string">
                            <MudStack Row Style="gap: 15px; white-space: nowrap;">
                                @if (_pullingData)
                                {
                                    <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                                }
                                else
                                {
                                    <MudIcon Style="opacity: 0.75;" Icon="@Icons.Material.Filled.Download" />
                                }

                                <MudText>@Loc["Pull Live Data"]</MudText>
                            </MudStack>
                        </MudListItem>
                    </MenuItemsTemplate>
                </UserAvatar>
            }
            else
            {
                <UserAvatar />
            }
        </MudAppBar>

        <MudDrawer @bind-Open="@_drawerOpen" ClipMode="DrawerClipMode.Docked" Elevation="1" Variant="@DrawerVariant.Mini" Breakpoint="Breakpoint.Lg" OpenMiniOnHover="true">
            <NavMenu isDrawerOpen="_drawerOpen" />
        </MudDrawer>

        <MudMainContent>
            <MudContainer MaxWidth="MaxWidth.ExtraLarge" Style="padding-block: 24px;">
                @Body
            </MudContainer>
        </MudMainContent>

    </MudLayout>

</MudRTLProvider>

@code {
    bool _drawerOpen = false;
    bool _pullingData = false;

    void DrawerToggle()
    {
        _drawerOpen = !_drawerOpen;
    }    

    async Task PullData()
    {
        if (this._pullingData)
            return;

        this._pullingData = true;

        StateHasChanged();

        try
        {
            await HttpClient.GetAsync("IdentitySync/pull-live-db-data");

            this._pullingData = false;

            StateHasChanged();

            Snackbar.Add(message: "Successfully Pulled Live Data", severity: Severity.Success);
        }
        catch (Exception ex)
        {
            this._pullingData = false;

            StateHasChanged();

            Snackbar.Add(message: ex.Message, severity: Severity.Error);
        }
    }
}