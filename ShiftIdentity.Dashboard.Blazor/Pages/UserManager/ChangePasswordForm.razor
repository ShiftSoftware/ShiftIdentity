@attribute [Authorize]
@layout Shared.DefaultLayout
@attribute [Route($"{Constants.IdentityRoutePreifix}/{nameof(ChangePasswordForm)}")]
@inject ShiftModal ShiftModal
@inject MessageService Message
@inject UserManagerService UserManager
@inject AuthService AuthService
@inject AuthenticationStateProvider authStateProvider
@inject NavigationManager NavManager
@inject HttpClient http
@inject ShiftIdentityLocalizer Loc
@using MudBlazor
@using ShiftSoftware.ShiftIdentity.Core

<MudPaper Elevation="25" Class="pa-5">
    @if (Enforce)
    {
        <MudAlert Severity="Severity.Info">@Loc["You must change your password"]</MudAlert>
    }

    <EditForm Model="@dto" OnValidSubmit="Save">
        <DataAnnotationsValidator />

        <MudTextField T="string" Label="@Loc["Current Password"]" @bind-Value="dto.CurrentPassword"
                      For="@(() => dto.CurrentPassword)" InputType="InputType.Password" />

        <MudTextField T="string" Label="@Loc["New Password"]" HelperText="@Loc["Choose a strong password"]" @bind-Value="dto.NewPassword"
                      For="@(() => dto.NewPassword)" InputType="@newPasswordInputType"
                      Adornment="Adornment.End"
                      AdornmentIcon="@GetNewPasswordAdornmentIcon()"
                      OnAdornmentClick="@OnNewPasswordAdornmentClick"
                      AdornmentAriaLabel="@GetNewPasswordAdornmentAriaLabel()" />

        <MudTextField T="string" Label="@Loc["Confirm Password"]" @bind-Value="dto.ConfirmPassword"
                      For="@(() => dto.ConfirmPassword)" InputType="InputType.Password" />

        <br />
        <br />

        <MudGrid Justify="Justify.FlexEnd">
            @if (MudDialog is not null)
            {
                <MudButton StartIcon="@Icons.Material.Filled.Cancel" OnClick="() => Cancel()">@Loc["Cancel"]</MudButton>
            }

            <MudButton Color="Color.Primary" ButtonType="ButtonType.Submit">
                <MudIcon Icon="@Icons.Material.Filled.Save" />
                <MudText Style="padding:0 10px;">@Loc["Save"]</MudText>
            </MudButton>
        </MudGrid>
    </EditForm>
</MudPaper>

@code {
    private ChangePasswordDTO dto = new ChangePasswordDTO();

    [CascadingParameter]
    protected IMudDialogInstance? MudDialog { get; set; }

    [Parameter]
    [SupplyParameterFromQuery]
    public bool Enforce { get; set; }

    [Parameter]
    [SupplyParameterFromQuery]
    public string? ReturnUrl { get; set; }

    private bool showNewPassword = false;
    private InputType newPasswordInputType => showNewPassword ? InputType.Text : InputType.Password;

    private string GetNewPasswordAdornmentIcon()
    {
        if (string.IsNullOrEmpty(dto.NewPassword))
            return Icons.Material.Filled.VpnKey;
        else
            return showNewPassword ? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff;
    }
    private string GetNewPasswordAdornmentAriaLabel()
    {
        if (string.IsNullOrEmpty(dto.NewPassword))
            return "Generate Password";
        else
            return showNewPassword ? "Hide Password" : "Show Password";
    }
    private void OnNewPasswordAdornmentClick()
    {
        if (string.IsNullOrEmpty(dto.NewPassword))
        {
            dto.NewPassword = PasswordGenerator.GeneratePassword(8);
            showNewPassword = true;
        }
        else
        {
            showNewPassword = !showNewPassword;
        }
    }

    private Task Cancel()
    {
        if (MudDialog is not null)
            ShiftModal.Close(MudDialog);

        return Task.CompletedTask;
    }

    private async Task Save()
    {
        var result = await UserManager.ChangePasswordAsync(dto);

        if (!result.IsSuccess)
        {
            Message.Error(result?.Data?.Message?.Body!, result?.Data?.Message?.Title);
            return;
        }

        if (MudDialog is not null)
        {
            ShiftModal.Close(MudDialog);
            return;
        }

        NavManager.NavigateTo(ReturnUrl ?? "/", true);
    }
}